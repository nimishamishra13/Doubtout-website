<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doubtout - Ask a Doubt</title>
    <!-- Load Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom font import and general base styles */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            /* Lighter, warmer background, consistent with other pages */
            background-color: #f0f8ff; 
        }

        /* Custom style for layered, high-contrast borders on main cards */
        .hand-drawn-card {
            border: 4px solid #1f2937; /* Strong, dark border */
            box-shadow: 8px 8px 0px 0px rgba(31, 41, 55, 0.4); /* Offset shadow for 3D effect */
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .hand-drawn-card:hover {
            box-shadow: 10px 10px 0px 0px rgba(31, 41, 55, 0.5); 
        }

        /* Bubbly CTA Button Styling (using blue accents) */
        .cta-button-blue {
            transition: all 0.15s ease-in-out;
            border-bottom: 4px solid rgba(0, 0, 0, 0.2); /* Creates a 'pressed' look */
        }
        .cta-button-blue:active {
            transform: translateY(2px);
            border-bottom-width: 2px;
            box-shadow: none;
        }

        /* Styling for the form inputs and selects */
        .form-input-field {
            width: 100%;
            padding: 12px;
            border: 2px solid #ccc;
            border-radius: 8px;
            font-size: 16px;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: all 0.2s;
        }
        .form-input-field:focus {
            outline: none;
            border-color: #3b82f6; /* Blue 500 */
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }
    </style>
</head>
<body>

    <!-- Main Header (Dark theme with Blue Accent) -->
    <header class="bg-gray-900 text-white shadow-xl">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-3">
                
                <!-- Logo Block (Blue Accent) -->
                <div class="flex items-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.206 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.794 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.794 5 16.5 5s3.332.477 4.5 1.253v13C19.832 18.477 18.206 18 16.5 18s-3.332.477-4.5 1.253" />
                    </svg>
                    <span class="text-xl font-bold tracking-tight text-blue-400">doubtout</span>
                </div>

                <!-- Global Navigation Links -->
                <nav class="hidden md:flex space-x-4">
                    <a href="/home.html" class="px-3 py-2 rounded-lg font-medium text-gray-300 hover:bg-gray-700 transition duration-150 ease-in-out">Home</a>
                    <a href="/answer_archive.html" class="px-3 py-2 rounded-lg font-medium text-gray-300 hover:bg-gray-700 transition duration-150 ease-in-out">Answer Archive</a>
                    <a href="/login.html" class="px-3 py-2 rounded-lg font-medium text-gray-300 hover:bg-gray-700 transition duration-150 ease-in-out">Login / Sign Up</a>
                </nav>
            </div>
        </div>
    </header>
    
    <!-- Sub-Navigation / Dashboard Links (Below Header) -->
    <nav class="bg-white shadow-md">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex justify-center flex-wrap space-x-4 sm:space-x-8 text-sm sm:text-base">
            <a href="student_dashboard.html" class="text-gray-700 hover:text-blue-600 font-semibold transition duration-150">My Dasboard</a>
            <a href="student_questions.html" class="text-gray-700 hover:text-blue-600 font-semibold transition duration-150">My Questions</a>
            <a href="student_contributions.html" class="text-gray-700 hover:text-blue-600 font-semibold transition duration-150">My Contributions</a>
            <a href="doubts.html" class="text-blue-600 border-b-2 border-blue-600 font-bold transition duration-150">Ask a Doubt</a>
            <a href="practice_session.html" class="text-gray-700 hover:text-blue-600 font-semibold transition duration-150">Practice Sessions</a>
        </div>
    </nav>


    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10 flex justify-center">
        
        <!-- Main Form Card (Hand-drawn style) -->
        <div class="w-full max-w-2xl p-8 bg-white rounded-xl hand-drawn-card">
            <h1 class="text-3xl font-extrabold text-gray-800 text-center mb-6 border-b-2 border-blue-500 pb-2">
                Ask a Doubt
            </h1>
            <p class="text-center text-gray-600 mb-8">
                Select the course details and type your question below.
            </p>

            <form id="doubt-form" class="space-y-6">

                <!-- Academic Details (Grid Layout for better flow) -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    
                    <!-- Branch Selection -->
                    <div>
                        <label for="branch" class="block text-sm font-medium text-gray-700 mb-2">Select Branch:</label>
                        <select id="branch" name="branch" required class="form-input-field">
                            <option value="" disabled selected>--Select Branch--</option>
                            <option value="3">Civil Engineering</option>
                            <option value="2">Mechanical Engineering</option>
                            <option value="5">Electronics and Communication Engineering</option>
                            <option value="1">Computer Science and Engineering</option>
                            <option value="4">Chemical Engineering</option>
                            <option value="6">Machine Learning (AI and ML)</option>
                        </select>
                    </div>

                    <!-- Semester Selection -->
                    <div>
                        <label for="semester" class="block text-sm font-medium text-gray-700 mb-2">Select Semester:</label>
                        <select id="semester" name="semester" required class="form-input-field">
                            <option value="" disabled selected>--Select Semester--</option>
                            <option value="1">Semester 1</option>
                            <option value="1">Semester 2</option>
                            <option value="3">Semester 3</option>
                            <option value="4">Semester 4</option>
                            <option value="5">Semester 5</option>
                            <option value="6">Semester 6</option>
                            <option value="7">Semester 7</option>
                            <option value="8">Semester 8</option>
                        </select>
                    </div>

                    <!-- Course Selection -->
                    <div>
                        <label for="course" class="block text-sm font-medium text-gray-700 mb-2">Select Course:</label>
                        <select id="course" class="form-input-field">
                            <option value="">-- Select Subject --</option>
                        </select>

                    </div>
                </div>

                <!-- Question Text Area -->
                <div>
                    <label for="question" class="block text-sm font-medium text-gray-700 mb-2">Your Question:</label>
                    <textarea id="question" name="question" rows="5" placeholder="Type your question clearly and precisely here... Add #your_topic_name at the end" required
                                 class="form-input-field resize-y"></textarea>
                </div>

                <!-- Mention Professor -->
                <div>
                    <label for="professor" class="block text-sm font-medium text-gray-700 mb-2">Mention Professor (Optional):</label>
                    <select id="professor" name="professor" class="form-input-field">
                        <option value="">--Select Professor--</option>
                    </select>

                </div>

                <!-- Submit Button -->
                <div>
                    <button type="submit" id="submit-button"
                            class="cta-button-blue w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-bold shadow-lg transition duration-200">
                        Submit Your Doubt
                    </button>
                </div>
            </form>
        </div>
    </main>

    
    <!-- JavaScript for Form Submission using localStorage and Backend API -->
   <script>
const API_URL = "http://localhost:3000/api";

const branchSelect = document.getElementById("branch");
const semesterSelect = document.getElementById("semester");
const courseSelect = document.getElementById("course");
const form = document.getElementById("doubt-form");

form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const userData = localStorage.getItem("doubtoutUser");
    if (!userData) {
        alert("Please login to submit a doubt.");
        window.location.href = "login.html";
        return;
    }

    const user = JSON.parse(userData);

    const payload = {
        user_id: Number(user.user_id),
        branch: Number(document.getElementById("branch").value),
        semester: Number(document.getElementById("semester").value),
        course: document.getElementById("course").value,
        question: document.getElementById("question").value.trim(),
        professor: document.getElementById("professor").value || null
    };

    if (!payload.course || !payload.question) {
        alert("Please fill all required fields.");
        return;
    }

    try {
        const res = await fetch(`${API_URL}/doubts`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

        const data = await res.json();

        if (!res.ok) {
            alert(data.error || "Failed to submit doubt");
            return;
        }

        const card = document.querySelector(".hand-drawn-card");

card.innerHTML = `
    <div class="p-8 text-center">
        <svg xmlns="http://www.w3.org/2000/svg"
             class="h-16 w-16 mx-auto text-green-500 mb-4"
             viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd"
                  d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                  clip-rule="evenodd" />
        </svg>

        <h3 class="text-2xl font-bold text-gray-800 mb-3">
            Doubt Submitted!
        </h3>

        <p class="text-gray-600 mb-6">
            Your question has been successfully submitted and will be reviewed by professors.
        </p>

        <a href="student_questions.html"
           class="cta-button-blue inline-block bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-bold">
            Go to My Questions
        </a>
    </div>
`;


    } catch (err) {
        console.error("Submit error:", err);
        alert("Server error while submitting doubt");
    }
});
async function loadSubjects() {
    const departmentId = branchSelect.value;
    const semester = semesterSelect.value;

    courseSelect.innerHTML = `<option value="">Loading subjects...</option>`;

    if (!departmentId || !semester) {
        courseSelect.innerHTML = `<option value="">-- Select Subject --</option>`;
        return;
    }

    try {
        const res = await fetch(
            `${API_URL}/subjects?department_id=${departmentId}&semester=${semester}`
        );
        const data = await res.json();

        courseSelect.innerHTML = `<option value="">-- Select Subject --</option>`;

        data.subjects.forEach(sub => {
            const opt = document.createElement("option");
            opt.value = sub.subject_name;
            opt.textContent = sub.subject_name;
            courseSelect.appendChild(opt);
        });

    } catch (err) {
        console.error("Failed to load subjects", err);
        courseSelect.innerHTML = `<option value="">Error loading subjects</option>`;
    }
}

branchSelect.addEventListener("change", loadSubjects);
semesterSelect.addEventListener("change", loadSubjects);
async function loadProfessors() {
    const professorSelect = document.getElementById("professor");
    professorSelect.innerHTML = `<option value="">Loading professors...</option>`;

    try {
        const res = await fetch("http://localhost:3000/api/professors");
        const data = await res.json();

        professorSelect.innerHTML = `<option value="">-- Select Professor --</option>`;

        data.professors.forEach(p => {
            const option = document.createElement("option");
            option.value = p.user_id;   // numeric ID
            option.textContent = p.full_name;
            professorSelect.appendChild(option);
        });

    } catch (err) {
        console.error("Failed to load professors:", err);
        professorSelect.innerHTML = `<option value="">Error loading professors</option>`;
    }
}

document.addEventListener("DOMContentLoaded", loadProfessors);


</script>
</body>
</html>